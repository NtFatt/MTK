{
  "info": {
    "_postman_id": "df3d57c1-564f-4ae3-adfb-a751e7974c3e",
    "name": "Hadilao Smoke - Negative Pack v1 (M4)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Negative pack prerequest (deterministic)",
          "const adminApiKey = pm.environment.get('adminApiKey');",
          "if (adminApiKey && String(adminApiKey).trim().length > 0) { pm.request.headers.upsert({ key: 'x-admin-api-key', value: adminApiKey }); }",
          "let runId = pm.environment.get('__runId');",
          "if (!runId) { runId = String(Date.now()); pm.environment.set('__runId', runId); }",
          "// Use unique phone per run to avoid collisions",
          "const phone = String(pm.environment.get('negClientPhone') || `09${runId}`);",
          "pm.environment.set('negClientPhone', phone);",
          "pm.environment.set('negPurpose', 'REGISTER');",
          "pm.environment.set('branchId', '1');",
          "pm.environment.set('branchOtherId', String(pm.environment.get('branchOtherId') || '999'));",
          "pm.environment.set('cashierUsername', String(pm.environment.get('cashierUsername') || `cashier_neg_${runId}`));",
          "pm.environment.set('kitchenUsername', String(pm.environment.get('kitchenUsername') || `kitchen_neg_${runId}`));",
          "const pass = String(pm.environment.get('negPass') || 'Passw0rd!123');",
          "pm.environment.set('cashierPassword', String(pm.environment.get('cashierPassword') || pass));",
          "pm.environment.set('kitchenPassword', String(pm.environment.get('kitchenPassword') || pass));",
          "pm.environment.set('idemKey', String(pm.environment.get('idemKey') || `idem_${runId}`));",
          "pm.environment.set('idemKey2', String(pm.environment.get('idemKey2') || `idem2_${runId}`));"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "00 - Setup / Admin login",
      "item": [
        {
          "name": "Admin login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{adminUsername}}\",\n  \"password\": \"{{adminPassword}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.test('token set', () => pm.expect(json.token).to.exist);",
                  "pm.environment.set('adminToken', String(json.token));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "01 - NEG-08 Validation error (400)",
      "item": [
        {
          "name": "OTP request missing phone -> 400",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/request",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 400', function () { pm.expect(pm.response.code).to.eql(400); });",
                  "let json=null; try{ json = pm.response.json(); } catch(e){ json=null; }",
                  "pm.test('code present', () => pm.expect(json && json.code).to.exist);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "02 - NEG-01 OTP request rate limit (429 on 4th)",
      "item": [
        {
          "name": "OTP request attempt 1",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/request",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('not rate limited yet', function(){ pm.expect(pm.response.code).to.not.eql(429); });"
                ]
              }
            }
          ]
        },
        {
          "name": "OTP request attempt 2",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/request",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('not rate limited yet', function(){ pm.expect(pm.response.code).to.not.eql(429); });"
                ]
              }
            }
          ]
        },
        {
          "name": "OTP request attempt 3",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/request",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('not rate limited yet', function(){ pm.expect(pm.response.code).to.not.eql(429); });"
                ]
              }
            }
          ]
        },
        {
          "name": "OTP request attempt 4",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/request",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 429', function () { pm.expect(pm.response.code).to.eql(429); });",
                  "let json=null; try{ json=pm.response.json(); }catch(e){json=null;}",
                  "pm.test('code RATE_LIMITED', () => pm.expect(json && json.code).to.eql('RATE_LIMITED'));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "03 - NEG-02 OTP verify rate limit (429 on 6th)",
      "item": [
        {
          "name": "OTP verify attempt 1",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/verify",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\",\n  \"otp\": \"000000\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('not rate limited yet', function(){ pm.expect(pm.response.code).to.not.eql(429); });"
                ]
              }
            }
          ]
        },
        {
          "name": "OTP verify attempt 2",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/verify",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\",\n  \"otp\": \"000000\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('not rate limited yet', function(){ pm.expect(pm.response.code).to.not.eql(429); });"
                ]
              }
            }
          ]
        },
        {
          "name": "OTP verify attempt 3",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/verify",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\",\n  \"otp\": \"000000\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('not rate limited yet', function(){ pm.expect(pm.response.code).to.not.eql(429); });"
                ]
              }
            }
          ]
        },
        {
          "name": "OTP verify attempt 4",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/verify",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\",\n  \"otp\": \"000000\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('not rate limited yet', function(){ pm.expect(pm.response.code).to.not.eql(429); });"
                ]
              }
            }
          ]
        },
        {
          "name": "OTP verify attempt 5",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/verify",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\",\n  \"otp\": \"000000\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('not rate limited yet', function(){ pm.expect(pm.response.code).to.not.eql(429); });"
                ]
              }
            }
          ]
        },
        {
          "name": "OTP verify attempt 6",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/client/otp/verify",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{negClientPhone}}\",\n  \"purpose\": \"{{negPurpose}}\",\n  \"otp\": \"000000\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 429', function () { pm.expect(pm.response.code).to.eql(429); });",
                  "let json=null; try{ json=pm.response.json(); }catch(e){json=null;}",
                  "pm.test('code RATE_LIMITED', () => pm.expect(json && json.code).to.eql('RATE_LIMITED'));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "04 - Setup data (tokens + orders)",
      "item": [
        {
          "name": "List tables -> pick 2x branch=1 + 1x branch=999",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/api/v1/tables"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "const items = json.items || json.tables || json || [];",
                  "const norm = (t) => ({",
                  "  id: String(t.id ?? t.tableId ?? t.table_id ?? ''),",
                  "  branchId: String(t.branchId ?? t.branch_id ?? ''),",
                  "  status: String(t.status ?? t.tableStatus ?? t.table_status ?? ''),",
                  "});",
                  "const arr = Array.isArray(items) ? items.map(norm) : [];",
                  "const avail = arr.filter(t => t.id && (t.status === 'AVAILABLE' || t.status === 'available'));",
                  "const b1 = avail.filter(t => t.branchId === '1');",
                  "const b999 = avail.filter(t => t.branchId === String(pm.environment.get('branchOtherId') || '999'));",
                  "pm.test('have >=2 tables in branch 1', () => pm.expect(b1.length).to.be.at.least(2));",
                  "pm.test('have >=1 table in branch 999', () => pm.expect(b999.length).to.be.at.least(1));",
                  "pm.environment.set('tableIdCash', b1[0].id);",
                  "pm.environment.set('tableIdMock', b1[1].id);",
                  "pm.environment.set('tableIdOther', b999[0].id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Create CASHIER (branch 1)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/staff",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{cashierUsername}}\",\n  \"password\": \"{{cashierPassword}}\",\n  \"role\": \"CASHIER\",\n  \"branchId\": \"1\",\n  \"fullName\": \"NEG CASHIER\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.test('staffId set', () => pm.expect(json.staffId).to.exist);"
                ]
              }
            }
          ]
        },
        {
          "name": "Login CASHIER -> cashierToken",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{cashierUsername}}\",\n  \"password\": \"{{cashierPassword}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('cashierToken', String(json.token));"
                ]
              }
            }
          ]
        },
        {
          "name": "Create KITCHEN (branch 1)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/staff",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{kitchenUsername}}\",\n  \"password\": \"{{kitchenPassword}}\",\n  \"role\": \"KITCHEN\",\n  \"branchId\": \"1\",\n  \"fullName\": \"NEG KITCHEN\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }"
                ]
              }
            }
          ]
        },
        {
          "name": "Login KITCHEN -> kitchenToken",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{kitchenUsername}}\",\n  \"password\": \"{{kitchenPassword}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('kitchenToken', String(json.token));"
                ]
              }
            }
          ]
        },
        {
          "name": "List menu items -> pick itemId",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/api/v1/menu/items?limit=50"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "const items = json.items || json || [];",
                  "pm.test('have menu items', () => pm.expect(items.length).to.be.above(0));",
                  "const it = items[0];",
                  "const id = String(it.id ?? it.itemId ?? it.item_id ?? it.menuItemId ?? '');",
                  "pm.test('itemId resolved', () => pm.expect(id).to.not.eql(''));",
                  "pm.environment.set('negItemId', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "DEV set-stock for branch 999 (ensure orderOther can be created)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/maintenance/dev/set-stock",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"branchId\": \"{{branchOtherId}}\",\n  \"itemId\": \"{{negItemId}}\",\n  \"quantity\": 10\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }"
                ]
              }
            }
          ]
        },
        {
          "name": "Open session (branch1-cash)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/sessions/open",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"tableId\": \"{{tableIdCash}}\",\n  \"partySize\": 2\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('sessionCash', String(json.sessionKey));"
                ]
              }
            }
          ]
        },
        {
          "name": "Create cart (branch1-cash)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/carts/session/{{sessionCash}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('cartCash', String(json.cartKey));"
                ]
              }
            }
          ]
        },
        {
          "name": "Add item to cart (branch1-cash)",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/carts/{{cartCash}}/items",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"itemId\": \"{{negItemId}}\",\n  \"quantity\": 1\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 200/204', function () { pm.expect([200, 204]).to.include(pm.response.code); });",
                  "if (![200, 204].includes(pm.response.code)) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "if (pm.response.code === 204) { pm.test('No Content (204) ok', function () { pm.expect(pm.response.text()).to.eql(''); }); } else {",
                  "  pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "  let json;",
                  "  try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Create order from cart (branch1-cash)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/orders/from-cart/{{cartCash}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('orderCash', String(json.orderCode));"
                ]
              }
            }
          ]
        },
        {
          "name": "Open session (branch1-mock)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/sessions/open",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"tableId\": \"{{tableIdMock}}\",\n  \"partySize\": 2\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('sessionMock', String(json.sessionKey));"
                ]
              }
            }
          ]
        },
        {
          "name": "Create cart (branch1-mock)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/carts/session/{{sessionMock}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('cartMock', String(json.cartKey));"
                ]
              }
            }
          ]
        },
        {
          "name": "Add item to cart (branch1-mock)",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/carts/{{cartMock}}/items",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"itemId\": \"{{negItemId}}\",\n  \"quantity\": 1\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 200/204', function () { pm.expect([200, 204]).to.include(pm.response.code); });",
                  "if (![200, 204].includes(pm.response.code)) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "if (pm.response.code === 204) { pm.test('No Content (204) ok', function () { pm.expect(pm.response.text()).to.eql(''); }); } else {",
                  "  pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "  let json;",
                  "  try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Create order from cart (branch1-mock)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/orders/from-cart/{{cartMock}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('orderMock', String(json.orderCode));"
                ]
              }
            }
          ]
        },
        {
          "name": "Open session (branch999-other)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/sessions/open",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"tableId\": \"{{tableIdOther}}\",\n  \"partySize\": 2\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('sessionOther', String(json.sessionKey));"
                ]
              }
            }
          ]
        },
        {
          "name": "Create cart (branch999-other)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/carts/session/{{sessionOther}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('cartOther', String(json.cartKey));"
                ]
              }
            }
          ]
        },
        {
          "name": "Add item to cart (branch999-other)",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/carts/{{cartOther}}/items",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"itemId\": \"{{negItemId}}\",\n  \"quantity\": 1\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 200/204', function () { pm.expect([200, 204]).to.include(pm.response.code); });",
                  "if (![200, 204].includes(pm.response.code)) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "if (pm.response.code === 204) { pm.test('No Content (204) ok', function () { pm.expect(pm.response.text()).to.eql(''); }); } else {",
                  "  pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "  let json;",
                  "  try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Create order from cart (branch999-other)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/orders/from-cart/{{cartOther}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('orderOther', String(json.orderCode));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "05 - NEG-03 Branch mismatch (403, no existence leak)",
      "item": [
        {
          "name": "CASHIER settle-cash on order from other branch -> 403",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{cashierToken}}"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{idemKey}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/cashier/settle-cash/{{orderOther}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 403', function () { pm.expect(pm.response.code).to.eql(403); });",
                  "let json=null; try{ json=pm.response.json(); }catch(e){json=null;}",
                  "pm.test('code FORBIDDEN', () => pm.expect(json && json.code).to.eql('FORBIDDEN'));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "06 - NEG-04 Kitchen forbidden to set PAID (403)",
      "item": [
        {
          "name": "KITCHEN change status PAID -> 403",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{kitchenToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/orders/{{orderCash}}/status",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"toStatus\": \"PAID\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 403', function () { pm.expect(pm.response.code).to.eql(403); });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "07 - NEG-05 Idempotency settle-cash duplicate (same response)",
      "item": [
        {
          "name": "Settle cash #1 (Idempotency-Key={{idemKey}})",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{cashierToken}}"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{idemKey}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/cashier/settle-cash/{{orderCash}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('settleCashStatus', String(pm.response.code));",
                  "pm.environment.set('settleCashBody', pm.response.text());"
                ]
              }
            }
          ]
        },
        {
          "name": "Settle cash #2 (same key) -> identical",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{cashierToken}}"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{idemKey}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/cashier/settle-cash/{{orderCash}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('same HTTP status', function(){ pm.expect(String(pm.response.code)).to.eql(String(pm.environment.get('settleCashStatus'))); });",
                  "pm.test('same body', function(){ pm.expect(pm.response.text()).to.eql(String(pm.environment.get('settleCashBody'))); });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "08 - NEG-06 Idempotency mock-success duplicate (same response)",
      "item": [
        {
          "name": "Mock success #1 (Idempotency-Key={{idemKey2}})",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{idemKey2}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/payments/mock-success/{{orderMock}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "pm.environment.set('mockStatus', String(pm.response.code));",
                  "pm.environment.set('mockBody', pm.response.text());"
                ]
              }
            }
          ]
        },
        {
          "name": "Mock success #2 (same key) -> identical",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{idemKey2}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/payments/mock-success/{{orderMock}}",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('same HTTP status', function(){ pm.expect(String(pm.response.code)).to.eql(String(pm.environment.get('mockStatus'))); });",
                  "pm.test('same body', function(){ pm.expect(pm.response.text()).to.eql(String(pm.environment.get('mockBody'))); });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "09 - NEG-07 Non-existing orderCode -> 404",
      "item": [
        {
          "name": "GET order status unknown -> 404",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/api/v1/orders/ORDFFFFFFFFFF/status"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 404', function () { pm.expect(pm.response.code).to.eql(404); });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "10 - NEG-10 Legacy API disabled -> /api/* returns 404",
      "item": [
        {
          "name": "NEG-10: GET /api/health must be 404 when LEGACY_API_ENABLED=false",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/api/health"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"HTTP status is 404\", function () {",
                  "  pm.response.to.have.status(404);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "11 - NEG-11 Internal endpoint missing token -> 401",
      "item": [
        {
          "name": "GET /admin/cashier/unpaid without token -> 401",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/api/v1/admin/cashier/unpaid"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 401', function () { pm.expect(pm.response.code).to.eql(401); });",
                  "let json=null; try{ json=pm.response.json(); }catch(e){json=null;}",
                  "pm.test('code UNAUTHORIZED', () => pm.expect(json && json.code).to.eql('UNAUTHORIZED'));"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}