{
  "info": {
    "_postman_id": "d2a1b9c6-6d88-4a8a-9f35-a135c3b1",
    "name": "Hadilao Smoke - Full Flow (7 Roles) v1",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Collection-level prerequest (SMOKE STABLE)",
          "// 1) Optional admin API key header (fallback auth)",
          "const adminApiKey = pm.environment.get('adminApiKey');",
          "if (adminApiKey && String(adminApiKey).trim().length > 0) {",
          "  pm.request.headers.upsert({ key: 'x-admin-api-key', value: adminApiKey });",
          "}",
          "// 2) SMOKE defaults to match seed.sql",
          "// Seed bạn từng show: Zone A (4 seats), Zone B (6 seats)",
          "const area = String(pm.environment.get('areaName') || '').trim();",
          "if (!area) pm.environment.set('areaName', 'Zone A');",
          "const ps = Number(pm.environment.get('partySize'));",
          "if (!Number.isFinite(ps) || ps <= 0) pm.environment.set('partySize', 2);",
          "// 3) Reservation time window (SMOKE SAFE)",
          "// Đặt reservedFrom ~ now + 5 phút để check-in luôn hợp lệ",
          "const reservedFromDate = new Date(Date.now() + 5 * 60 * 1000);",
          "const reservedToDate   = new Date(reservedFromDate.getTime() + 60 * 60 * 1000);",
          "",
          "pm.environment.set('reservedFrom', reservedFromDate.toISOString());",
          "pm.environment.set('reservedTo', reservedToDate.toISOString());",
          "",
          "// 4) RunId + dynamic test users (7 roles smoke)",
          "let runId = pm.environment.get(\"__runId\");",
          "if (!runId) { runId = String(Date.now()); pm.environment.set(\"__runId\", runId); }",
          "",
          "// 5) Default branchId for STAFF/KITCHEN/CASHIER/BRANCH_MANAGER",
          "const b = String(pm.environment.get(\"smokeBranchId\") || \"1\").trim();",
          "pm.environment.set(\"branchId\", b || \"1\");",
          "",
          "// 6) Deterministic passwords for internal users",
          "const defaultPass = String(pm.environment.get(\"staffPassword\") || \"Passw0rd!123\");",
          "pm.environment.set(\"staffPassword\", defaultPass);",
          "pm.environment.set(\"kitchenPassword\", String(pm.environment.get(\"kitchenPassword\") || defaultPass));",
          "pm.environment.set(\"cashierPassword\", String(pm.environment.get(\"cashierPassword\") || defaultPass));",
          "pm.environment.set(\"managerPassword\", String(pm.environment.get(\"managerPassword\") || defaultPass));",
          "",
          "// 7) Unique usernames per run (avoid duplicate constraint)",
          "pm.environment.set(\"staffUsername\", String(pm.environment.get(\"staffUsername\") || `staff_smoke_${runId}`));",
          "pm.environment.set(\"kitchenUsername\", String(pm.environment.get(\"kitchenUsername\") || `kitchen_smoke_${runId}`));",
          "pm.environment.set(\"cashierUsername\", String(pm.environment.get(\"cashierUsername\") || `cashier_smoke_${runId}`));",
          "pm.environment.set(\"managerUsername\", String(pm.environment.get(\"managerUsername\") || `bm_smoke_${runId}`));"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "00 - Client Auth (OTP)",
      "item": [
        {
          "name": "Request OTP (REGISTER)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/client/otp/request",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "client",
                "otp",
                "request"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{clientPhone}}\",\n  \"purpose\": \"REGISTER\"\n}"
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// Always generate a fresh phone for REGISTER smoke (idempotent)",
                  "const suffix = String(Date.now()).slice(-8);     // 8 digits",
                  "pm.environment.set(\"clientPhone\", \"09\" + suffix);"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const j = pm.response.json();",
                  "if (j.otpId) pm.environment.set('otpId', String(j.otpId));",
                  "if (j.devEchoOtp) pm.environment.set('otpCode', String(j.devEchoOtp));",
                  "// If devEchoOtp is disabled, set otpCode manually in environment."
                ]
              }
            }
          ]
        },
        {
          "name": "Verify OTP (REGISTER) => Tokens",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/client/otp/verify",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "client",
                "otp",
                "verify"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"{{clientPhone}}\",\n  \"purpose\": \"REGISTER\",\n  \"otp\": \"{{otpCode}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const j = pm.response.json();",
                  "pm.environment.set('clientAccessToken', String(j.accessToken || ''));",
                  "pm.environment.set('clientRefreshToken', String(j.refreshToken || ''));",
                  "if (j.client && j.client.clientId) pm.environment.set('clientId', String(j.client.clientId));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "00 - Admin",
      "item": [
        {
          "name": "Admin Login (Bearer token)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/login",
            "body": {
              "mode": "raw",
              "raw": "{\"username\": \"{{adminUsername}}\", \"password\": \"{{adminPassword}}\"}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 200', function () { pm.expect(pm.response.code).to.eql(200); });",
                  "if (pm.response.code !== 200) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test('login returns token', function(){",
                  "  const token = json.token || json.accessToken || (json.data && (json.data.token || json.data.accessToken));",
                  "  pm.expect(token, 'token').to.be.a('string').and.to.have.length.greaterThan(10);",
                  "  pm.environment.set('adminToken', token);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "01 - Health",
      "item": [
        {
          "name": "Health",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/api/v1/health"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test('health ok', function(){ pm.expect(json).to.be.ok; });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "02 - Menu",
      "item": [
        {
          "name": "List Menu Items (pick first itemId)",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/api/v1/menu/items?limit=50"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });let json;try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }const itemsWrap = json.items ? json : (json.data && json.data.items ? json.data : json);const items = (itemsWrap && itemsWrap.items) ? itemsWrap.items : (Array.isArray(itemsWrap) ? itemsWrap : []);pm.test('menu has items', function(){ pm.expect(items.length, 'items length').to.be.greaterThan(0); });function stockOf(it){ const v = (it && (it.stockQty ?? it.stock_qty ?? it.stock ?? it.quantity ?? 0)); const n = Number(v); return Number.isFinite(n) ? n : 0; }const pick = items.find(it => stockOf(it) > 0) || items[0];const id = pick && (pick.menuItemId || pick.itemId || pick.item_id || pick.id);pm.test('pick menuItemId', function(){ pm.expect(id, 'menuItemId').to.exist; });pm.environment.set('menuItemId', String(id));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "03 - Reservation Flow",
      "item": [
        {
          "name": "Create Reservation (client)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/reservations",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"areaName\": \"{{areaName}}\",\n  \"partySize\": {{partySize}},\n  \"contactName\": \"Smoke Tester\",\n  \"contactPhone\": \"0900000000\",\n  \"note\": \"smoke\",\n  \"reservedFrom\": \"{{reservedFrom}}\",\n  \"reservedTo\": \"{{reservedTo}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "// SUCCESS",
                  "if (status === 201) {",
                  "  pm.test('HTTP 201', () => pm.expect(status).to.eql(201));",
                  "  pm.test('Content-Type is JSON', () => pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'));",
                  "",
                  "  let json;",
                  "  try { json = pm.response.json(); }",
                  "  catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "",
                  "  const code = json.reservationCode || (json.data && json.data.reservationCode);",
                  "  pm.test('reservationCode set', () => pm.expect(code, 'reservationCode').to.exist);",
                  "  pm.environment.set('reservationCode', String(code));",
                  "  return;",
                  "}",
                  "// Parse JSON for error handling",
                  "let json = null;",
                  "try { json = pm.response.json(); } catch (_) {}",
                  "// If no table available -> retry once with other zone",
                  "const errCode = (json && (json.code || (json.error && json.error.code))) || '';",
                  "if (status === 409 && errCode === 'NO_TABLE_AVAILABLE') {",
                  "  const retry = Number(pm.environment.get('__rsv_retry') || 0);",
                  "  if (retry < 1) {",
                  "    pm.environment.set('__rsv_retry', String(retry + 1));",
                  "",
                  "    const current = String(pm.environment.get('areaName') || '').trim();",
                  "    const next = (current === 'Zone A') ? 'Zone B' : 'Zone A';",
                  "    pm.environment.set('areaName', next);",
                  "",
                  "    console.log(`NO_TABLE_AVAILABLE on ${current}. Retrying once with areaName=${next}`);",
                  "    pm.execution.setNextRequest(pm.info.requestName); // retry same request",
                  "    return;",
                  "  }",
                  "}",
                  "// FAIL hard",
                  "console.log(pm.response.text());",
                  "pm.execution.setNextRequest(null);",
                  "throw new Error(`Create Reservation failed: HTTP ${status} (${errCode || 'UNKNOWN'})`);"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Confirm Reservation",
          "request": {
            "method": "PATCH",
            "header": [],
            "url": "{{baseUrl}}/api/v1/admin/reservations/{{reservationCode}}/confirm",
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{adminToken}}",
                  "type": "string"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "if (pm.response.code === 204) { pm.test('confirm ok (no content)', function(){ pm.expect(true).to.equal(true); }); }",
                  "else {",
                  "  pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "  let json;",
                  "  try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "  pm.test('confirm ok', function(){ pm.expect(json).to.be.ok; });",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Check-in Reservation (opens session)",
          "request": {
            "method": "POST",
            "header": [],
            "url": "{{baseUrl}}/api/v1/admin/reservations/{{reservationCode}}/checkin",
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{adminToken}}",
                  "type": "string"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "const sessionKey = json.sessionKey || (json.data && json.data.sessionKey);",
                  "pm.test('sessionKey set', function(){ pm.expect(sessionKey, 'sessionKey').to.exist; });",
                  "pm.environment.set('sessionKey', String(sessionKey));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "04 - Cart + Order + Payment",
      "item": [
        {
          "name": "Get/Create cart by sessionKey",
          "request": {
            "method": "POST",
            "header": [],
            "url": "{{baseUrl}}/api/v1/carts/session/{{sessionKey}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "const cartKey = json.cartKey || (json.data && (json.data.cartKey || (json.data.cart && json.data.cart.cartKey))) || (json.cart && json.cart.cartKey);",
                  "pm.test('cartKey set', function(){ pm.expect(cartKey, 'cartKey').to.exist; });",
                  "pm.environment.set('cartKey', String(cartKey));"
                ]
              }
            }
          ]
        },
        {
          "name": "Upsert Cart Item",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/carts/{{cartKey}}/items",
            "body": {
              "mode": "raw",
              "raw": "{\"itemId\": \"{{menuItemId}}\", \"quantity\": 1}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP is one of [200, 204]', function () { pm.expect([200, 204]).to.include(pm.response.code); });",
                  "if (![200, 204].includes(pm.response.code)) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Order from Cart",
          "request": {
            "method": "POST",
            "header": [],
            "url": "{{baseUrl}}/api/v1/orders/from-cart/{{cartKey}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 201', function () { pm.expect(pm.response.code).to.eql(201); });",
                  "if (pm.response.code !== 201) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "const orderCode = json.orderCode || (json.data && json.data.orderCode);",
                  "pm.test('orderCode set', function(){ pm.expect(orderCode, 'orderCode').to.exist; });",
                  "pm.environment.set('orderCode', String(orderCode));"
                ]
              }
            }
          ]
        },
        {
          "name": "Mock Payment SUCCESS (admin)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Idempotency-Key",
                "value": "{{$guid}}",
                "type": "text"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/payments/mock-success/{{orderCode}}",
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{adminToken}}",
                  "type": "string"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 201', function () { pm.expect(pm.response.code).to.eql(201); });",
                  "if (pm.response.code !== 201) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test('paid ok', function(){ pm.expect(json).to.be.ok; });"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Order Status",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/api/v1/orders/{{orderCode}}/status"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test('order status exists', function(){ pm.expect(json.status || json.orderStatus || (json.data && json.data.status), 'status').to.exist; });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "05 - Close + Maintenance",
      "item": [
        {
          "name": "Close Session",
          "request": {
            "method": "POST",
            "header": [],
            "url": "{{baseUrl}}/api/v1/sessions/{{sessionKey}}/close"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test('close ok', function(){ pm.expect(json).to.be.ok; });"
                ]
              }
            }
          ]
        },
        {
          "name": "Run Maintenance (admin)",
          "request": {
            "method": "POST",
            "header": [],
            "url": "{{baseUrl}}/api/v1/admin/maintenance/run",
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{adminToken}}",
                  "type": "string"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP status is 2xx', function () { pm.expect(pm.response.code).to.be.within(200, 299); });",
                  "if (pm.response.code < 200 || pm.response.code > 299) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw new Error('HTTP ' + pm.response.code); }",
                  "pm.test('Content-Type is JSON', function () { pm.expect(pm.response.headers.get('Content-Type') || '').to.include('application/json'); });",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test('maintenance ok', function(){ pm.expect(json).to.be.ok; });"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "06 - Internal Roles (7 roles)",
      "item": [
        {
          "name": "Create STAFF user (admin)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/staff",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{staffUsername}}\",\n  \"password\": \"{{staffPassword}}\",\n  \"role\": \"STAFF\",\n  \"branchId\": \"{{branchId}}\",\n  \"fullName\": \"Smoke STAFF\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 201\", () => pm.expect(status).to.eql(201));",
                  "let json=null;",
                  "try { json = pm.response.json(); } catch (_) { json = null; }",
                  "pm.test(\"staffId set\", () => pm.expect(json && json.staffId).to.exist);"
                ]
              }
            }
          ]
        },
        {
          "name": "Create KITCHEN user (admin)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/staff",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{kitchenUsername}}\",\n  \"password\": \"{{kitchenPassword}}\",\n  \"role\": \"KITCHEN\",\n  \"branchId\": \"{{branchId}}\",\n  \"fullName\": \"Smoke KITCHEN\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 201\", () => pm.expect(status).to.eql(201));",
                  "let json=null;",
                  "try { json = pm.response.json(); } catch (_) { json = null; }"
                ]
              }
            }
          ]
        },
        {
          "name": "Create CASHIER user (admin)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/staff",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{cashierUsername}}\",\n  \"password\": \"{{cashierPassword}}\",\n  \"role\": \"CASHIER\",\n  \"branchId\": \"{{branchId}}\",\n  \"fullName\": \"Smoke CASHIER\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 201\", () => pm.expect(status).to.eql(201));",
                  "let json=null;",
                  "try { json = pm.response.json(); } catch (_) { json = null; }"
                ]
              }
            }
          ]
        },
        {
          "name": "Create BRANCH_MANAGER user (admin)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/staff",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{managerUsername}}\",\n  \"password\": \"{{managerPassword}}\",\n  \"role\": \"BRANCH_MANAGER\",\n  \"branchId\": \"{{branchId}}\",\n  \"fullName\": \"Smoke BM\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 201\", () => pm.expect(status).to.eql(201));",
                  "let json=null;",
                  "try { json = pm.response.json(); } catch (_) { json = null; }"
                ]
              }
            }
          ]
        },
        {
          "name": "Login STAFF (internal token)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{staffUsername}}\",\n  \"password\": \"{{staffPassword}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP status is 2xx\", () => pm.expect(status).to.be.within(200,299));",
                  "pm.test(\"Content-Type is JSON\", () => pm.expect(pm.response.headers.get(\"Content-Type\")||\"\").to.include(\"application/json\"));",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test(\"token set\", () => pm.expect(json.token).to.exist);",
                  "pm.environment.set(\"staffToken\", String(json.token));"
                ]
              }
            }
          ]
        },
        {
          "name": "Login KITCHEN (internal token)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{kitchenUsername}}\",\n  \"password\": \"{{kitchenPassword}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP status is 2xx\", () => pm.expect(status).to.be.within(200,299));",
                  "pm.test(\"Content-Type is JSON\", () => pm.expect(pm.response.headers.get(\"Content-Type\")||\"\").to.include(\"application/json\"));",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test(\"token set\", () => pm.expect(json.token).to.exist);",
                  "pm.environment.set(\"kitchenToken\", String(json.token));"
                ]
              }
            }
          ]
        },
        {
          "name": "Login CASHIER (internal token)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{cashierUsername}}\",\n  \"password\": \"{{cashierPassword}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP status is 2xx\", () => pm.expect(status).to.be.within(200,299));",
                  "pm.test(\"Content-Type is JSON\", () => pm.expect(pm.response.headers.get(\"Content-Type\")||\"\").to.include(\"application/json\"));",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test(\"token set\", () => pm.expect(json.token).to.exist);",
                  "pm.environment.set(\"cashierToken\", String(json.token));"
                ]
              }
            }
          ]
        },
        {
          "name": "Login BRANCH_MANAGER (internal token)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{managerUsername}}\",\n  \"password\": \"{{managerPassword}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP status is 2xx\", () => pm.expect(status).to.be.within(200,299));",
                  "pm.test(\"Content-Type is JSON\", () => pm.expect(pm.response.headers.get(\"Content-Type\")||\"\").to.include(\"application/json\"));",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test(\"token set\", () => pm.expect(json.token).to.exist);",
                  "pm.environment.set(\"managerToken\", String(json.token));"
                ]
              }
            }
          ]
        },
        {
          "name": "STAFF: List tables (branch-scope)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{staffToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/ops/tables?branchId=999&limit=50"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP status is 2xx\", () => pm.expect(status).to.be.within(200,299));",
                  "pm.test(\"Content-Type is JSON\", () => pm.expect(pm.response.headers.get(\"Content-Type\")||\"\").to.include(\"application/json\"));",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test(\"items exists\", () => pm.expect(json.items).to.be.an(\"array\"));",
                  "pm.test(\"items not empty\", () => pm.expect(json.items.length).to.be.greaterThan(0));",
                  "const b = String(pm.environment.get(\"branchId\"));",
                  "pm.test(\"branch-scope enforced\", () => {",
                  "  for (const it of json.items) { pm.expect(String(it.branchId)).to.eql(b); }",
                  "});",
                  "pm.environment.set(\"opsDirectionId\", String(json.items[0].directionId));",
                  "pm.environment.set(\"opsTableId\", String(json.items[0].id));"
                ]
              }
            }
          ]
        },
        {
          "name": "STAFF: List tables via legacy /api/admin (compat)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{staffToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/admin/ops/tables?branchId=999&limit=10"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "// M0 Contract Lock: legacy /api/* is expected to be 404 when LEGACY_API_ENABLED=false.",
                  "// To keep smoke usable across both modes, accept either:",
                  "// - 404 (legacy disabled) OR",
                  "// - 2xx with items[] (legacy enabled).",
                  "pm.test('Content-Type is JSON', () => pm.expect(pm.response.headers.get('Content-Type')||'').to.include('application/json'));",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); throw e; }",
                  "if (status === 404) {",
                  "  pm.test('Legacy disabled => 404 Not Found', () => pm.expect(status).to.eql(404));",
                  "  pm.test('Legacy disabled => NOT_FOUND code', () => pm.expect(json.code || json.error?.code).to.match(/NOT_FOUND|ROUTE_NOT_FOUND/));",
                  "} else {",
                  "  pm.test('Legacy enabled => HTTP status is 2xx', () => pm.expect(status).to.be.within(200,299));",
                  "  pm.test('items exists', () => pm.expect(json.items).to.be.an('array'));",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "STAFF: Open session (ops)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{staffToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/ops/sessions/open",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"directionId\": \"{{opsDirectionId}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP is 200 or 201\", () => pm.expect([200,201]).to.include(status));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test(\"sessionKey set\", () => pm.expect(json.sessionKey).to.exist);",
                  "pm.environment.set(\"opsSessionKey\", String(json.sessionKey));",
                  "pm.environment.set(\"opsSessionId\", String(json.sessionId || \"\"));"
                ]
              }
            }
          ]
        },
        {
          "name": "STAFF: Get/Create cart (ops)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{staffToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/ops/carts/session/{{opsSessionKey}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP status is 2xx\", () => pm.expect(status).to.be.within(200,299));",
                  "pm.test(\"Content-Type is JSON\", () => pm.expect(pm.response.headers.get(\"Content-Type\")||\"\").to.include(\"application/json\"));",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test(\"cartKey set\", () => pm.expect(json.cartKey).to.exist);",
                  "pm.environment.set(\"opsCartKey\", String(json.cartKey));"
                ]
              }
            }
          ]
        },
        {
          "name": "STAFF: Upsert cart item (ops) => create Redis hold",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{staffToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/ops/carts/{{opsCartKey}}/items",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"itemId\": \"{{menuItemId}}\",\n  \"qty\": 1\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 204\", () => pm.expect(status).to.eql(204));"
                ]
              }
            }
          ]
        },
        {
          "name": "BRANCH_MANAGER: List Active Holds (should include opsCartKey)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{managerToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/inventory/holds?branchId=999&limit=200"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 200\", () => pm.expect(status).to.eql(200));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); throw e; }",
                  "pm.test(\"holds is array\", () => pm.expect(json.items).to.be.an(\"array\"));",
                  "const cartKey = String(pm.environment.get(\"opsCartKey\"));",
                  "if (json.items.length > 0) {",
                  "  pm.test(\"hold matches cartKey (at least one)\", () => pm.expect(json.items.some(h => String(h.cartKey) === cartKey)).to.be.true);",
                  "} else {",
                  "  // If holds are not indexed yet (timing), we still allow pass but log.",
                  "  console.log(\"No holds found - check Redis holdidx indexing/TTL\");",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "STAFF: Create order from cart (ops) => consume hold",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{staffToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/ops/orders/from-cart/{{opsCartKey}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 201\", () => pm.expect(status).to.eql(201));",
                  "let json=null;",
                  "try { json = pm.response.json(); } catch (_) { json = null; }",
                  "const orderCode = json && (json.orderCode || json.code);",
                  "pm.test(\"orderCode set\", () => pm.expect(orderCode).to.exist);",
                  "pm.environment.set(\"opsOrderCode\", String(orderCode));"
                ]
              }
            }
          ]
        },
        {
          "name": "KITCHEN: List queue (NEW) includes opsOrderCode",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{kitchenToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/kitchen/queue?statuses=NEW&limit=50"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 200\", () => pm.expect(status).to.eql(200));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); throw e; }",
                  "pm.test(\"items is array\", () => pm.expect(json.items).to.be.an(\"array\"));",
                  "const oc = String(pm.environment.get(\"opsOrderCode\"));",
                  "pm.test(\"queue contains order\", () => pm.expect(json.items.some(o => String(o.orderCode) === oc)).to.be.true);"
                ]
              }
            }
          ]
        },
        {
          "name": "KITCHEN: Change order status -> RECEIVED",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{kitchenToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/orders/{{opsOrderCode}}/status",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"toStatus\": \"RECEIVED\",\n  \"note\": \"kitchen received (smoke)\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP status is 2xx\", () => pm.expect(status).to.be.within(200,299));",
                  "pm.test(\"Content-Type is JSON\", () => pm.expect(pm.response.headers.get(\"Content-Type\")||\"\").to.include(\"application/json\"));",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test(\"changed true\", () => pm.expect(json.changed).to.eql(true));"
                ]
              }
            }
          ]
        },
        {
          "name": "CASHIER: List unpaid orders includes opsOrderCode",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{cashierToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/cashier/unpaid?branchId=999&limit=50"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 200\", () => pm.expect(status).to.eql(200));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); throw e; }",
                  "pm.test(\"items is array\", () => pm.expect(json.items).to.be.an(\"array\"));",
                  "const oc = String(pm.environment.get(\"opsOrderCode\"));",
                  "pm.test(\"unpaid contains order\", () => pm.expect(json.items.some(o => String(o.orderCode) === oc)).to.be.true);"
                ]
              }
            }
          ]
        },
        {
          "name": "CASHIER: Settle cash payment -> PAID",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{cashierToken}}"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{$guid}}",
                "type": "text"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/cashier/settle-cash/{{opsOrderCode}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 200/201\", () => pm.expect([200,201]).to.include(status));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); throw e; }",
                  "pm.test(\"settled true or already\", () => pm.expect(typeof json.changed).to.eql(\"boolean\"));"
                ]
              }
            }
          ]
        },
        {
          "name": "STAFF: Get order status (ops) => PAID",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{staffToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/ops/orders/{{opsOrderCode}}/status"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 200\", () => pm.expect(status).to.eql(200));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); throw e; }",
                  "pm.test(\"status is PAID\", () => pm.expect(String(json.status)).to.eql(\"PAID\"));"
                ]
              }
            }
          ]
        },
        {
          "name": "STAFF: Close session (ops)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{staffToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/ops/sessions/{{opsSessionKey}}/close"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP status is 2xx\", () => pm.expect(status).to.be.within(200,299));",
                  "pm.test(\"Content-Type is JSON\", () => pm.expect(pm.response.headers.get(\"Content-Type\")||\"\").to.include(\"application/json\"));",
                  "let json;",
                  "try { json = pm.response.json(); } catch (e) { console.log(pm.response.text()); pm.execution.setNextRequest(null); throw e; }",
                  "pm.test(\"closed\", () => pm.expect(String(json.status)).to.eql(\"CLOSED\"));"
                ]
              }
            }
          ]
        },
        {
          "name": "NEGATIVE: STAFF cannot settle payments (403)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{staffToken}}"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{$guid}}",
                "type": "text"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/cashier/settle-cash/{{opsOrderCode}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"HTTP 403\", () => pm.expect(pm.response.code).to.eql(403));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "07 - Inventory + Menu Cache (Branch Manager)",
      "item": [
        {
          "name": "BRANCH_MANAGER: Get stock (branch-scope forced)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{managerToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/inventory/stock?branchId=999"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 200\", () => pm.expect(status).to.eql(200));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); throw e; }",
                  "pm.test(\"items array\", () => pm.expect(json.items).to.be.an(\"array\"));",
                  "const b = String(pm.environment.get(\"branchId\"));",
                  "if (json.items.length > 0) {",
                  "  pm.test(\"all rows branchId==actor branch\", () => {",
                  "    for (const it of json.items) pm.expect(String(it.branchId)).to.eql(b);",
                  "  });",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "BRANCH_MANAGER: Adjust stock (SET) -> sync Redis + bump menuVer",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{managerToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/inventory/stock/adjust",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"branchId\": \"999\",\n  \"itemId\": \"{{menuItemId}}\",\n  \"mode\": \"SET\",\n  \"quantity\": 50\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 200\", () => pm.expect(status).to.eql(200));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); throw e; }",
                  "const b = String(pm.environment.get(\"branchId\"));",
                  "pm.test(\"branchId forced\", () => pm.expect(String(json.branchId)).to.eql(b));",
                  "pm.test(\"newQty is number\", () => pm.expect(Number.isFinite(json.newQty)).to.be.true);",
                  "if (json.redis) {",
                  "  pm.test(\"redis sync fields exist\", () => {",
                  "    pm.expect(json.redis.stockKey).to.exist;",
                  "    pm.expect(json.redis.available).to.be.a(\"number\");",
                  "  });",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "BRANCH_MANAGER: Bump menu version (explicit)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{managerToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/inventory/menu/bump"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 200\", () => pm.expect(status).to.eql(200));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); throw e; }",
                  "pm.test(\"version set\", () => pm.expect(json.version).to.exist);"
                ]
              }
            }
          ]
        },
        {
          "name": "Inventory drift metrics (Redis)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{managerToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/inventory/rehydrate/metrics"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"HTTP 200\", () => pm.expect(pm.response.code).to.eql(200));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "08 - Realtime + Observability",
      "item": [
        {
          "name": "Realtime Snapshot (sessionKey room)",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/v1/realtime/snapshot?room=sessionKey:{{sessionKey}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const status = pm.response.code;",
                  "pm.test(\"HTTP 200\", () => pm.expect(status).to.eql(200));",
                  "let json;",
                  "try { json = pm.response.json(); } catch(e) { console.log(pm.response.text()); throw e; }",
                  "pm.test(\"ok true\", () => pm.expect(json.ok).to.eql(true));"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Observability: Slow queries (admin)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/observability/slow-queries?limit=20&minMs=0"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"HTTP 200\", () => pm.expect(pm.response.code).to.eql(200));"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Realtime Audit: list (admin)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/admin/realtime/audit?limit=20&room=admin"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"HTTP 200\", () => pm.expect(pm.response.code).to.eql(200));"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}