# =============================
# Hadilao Online API - ENV (Local dev)
# =============================
NODE_ENV=development
PORT=3001
BASE_URL=http://localhost:3001

# ---- Contract lock (M0) ----
# Legacy /api/* routes are deprecated and OFF by default.
LEGACY_API_ENABLED=false


# ---- Observability ----
LOG_LEVEL=debug
# Pretty console logs for local dev (true/false)
LOG_PRETTY=true
# Prometheus metrics endpoint
METRICS_ENABLED=true
METRICS_PATH=/api/v1/metrics
# Require admin token for metrics (recommended in prod)
METRICS_REQUIRE_ADMIN=true
# Slow query threshold (ms)
SLOW_QUERY_MS=200
# Slow Redis command threshold (ms)
REDIS_SLOW_OP_MS=50

# ---- Idempotency (M2) ----
# Used by payment mock-success + cashier settle-cash.
IDEMPOTENCY_TTL_SECONDS=600

# ---- OpenTelemetry (Phase 3 - optional) ----
OTEL_ENABLED=false
OTEL_SERVICE_NAME=hadilao-api
# Default collector (OTLP/HTTP). Use your local collector endpoint.
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces
OTEL_TRACES_SAMPLER=parentbased_traceidratio
OTEL_TRACES_SAMPLER_ARG=0.2
# Example: service.version=1.0.0,deployment.environment=local
OTEL_RESOURCE_ATTRIBUTES=


# ---- MySQL ----
MYSQL_HOST=127.0.0.1
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=123456
MYSQL_DATABASE=hadilao_online

# ---- Redis / Realtime (optional) ----
# If REDIS_URL is set, REALTIME_ENABLED defaults to true.
REDIS_URL=redis://127.0.0.1:6379
REALTIME_ENABLED=true
SOCKET_PATH=/socket.io
# Optional: enable Socket.IO Redis adapter (multi-instance). Needs @socket.io/redis-adapter
SOCKET_REDIS_ADAPTER_ENABLED=false
REALTIME_EVENT_VERSION=1
# Enable admin realtime audit trail (requires migration 010_p2_realtime_admin_audit.sql)
REALTIME_ADMIN_AUDIT_ENABLED=true

# ---- Realtime replay / seq gap recovery (Phase 2) ----
# Enable per-room replay log (Redis ZSET) used by Socket join.v1 + replay.v1.
# If omitted, defaults to (REALTIME_ENABLED || REDIS_URL set).
REALTIME_REPLAY_ENABLED=true
# Ephemeral retention window (seconds)
REALTIME_REPLAY_TTL_SECONDS=3600
# Max events kept per room
REALTIME_REPLAY_MAX_ITEMS=2000
# Max replay items returned per request (server clamp)
REALTIME_REPLAY_MAX_LIMIT=500


# ---- Redis Session Store (Phase 1) ----
# Defaults to true when REDIS_URL is set (unless explicitly set to false).
REDIS_SESSION_STORE_ENABLED=true
REDIS_SESSION_TTL_SECONDS=21600

# ---- Redis Stock Holds (Phase 1) ----
# Defaults to true when REDIS_URL is set (unless explicitly set to false).
REDIS_STOCK_HOLDS_ENABLED=true
REDIS_STOCK_HOLD_TTL_SECONDS=300
REDIS_STOCK_HOLD_CLEANUP_INTERVAL_SECONDS=15

# ---- Inventory drift control (Phase 2) ----
# Cron-like rehydrate: recompute Redis available stock from MySQL SoT - reserved ledger.
STOCK_REHYDRATE_ENABLED=false
STOCK_REHYDRATE_INTERVAL_SECONDS=60

# ---- Redis Menu Cache (optional) ----
MENU_CACHE_ENABLED=true
MENU_CACHE_TTL_SECONDS=600

# ---- Client OTP Auth + Refresh rotation ----
# OTP is stored hashed in DB (otp_requests). In dev you can enable echo to skip SMS integration.
OTP_HASH_SECRET=change_me_to_a_long_random_string
OTP_TTL_SECONDS=300
DEV_OTP_ECHO_ENABLED=true
DEV_OTP_FIXED_CODE=123456

# ---- Rate limit (M3) ----
RL_OTP_REQUEST_LIMIT=3
RL_OTP_REQUEST_WINDOW_SECONDS=60
RL_OTP_VERIFY_LIMIT=5
RL_OTP_VERIFY_WINDOW_SECONDS=60
RL_ADMIN_LOGIN_LIMIT=3
RL_ADMIN_LOGIN_WINDOW_SECONDS=60


# Access + refresh tokens (HMAC signed, JWT-like)
CLIENT_ACCESS_TOKEN_SECRET=change_me_to_a_long_random_string
CLIENT_ACCESS_TOKEN_TTL_MINUTES=15

CLIENT_REFRESH_TOKEN_SECRET=change_me_to_a_long_random_string
CLIENT_REFRESH_TOKEN_TTL_DAYS=30

# Hash secret for storing refresh tokens safely (never store raw refresh token)
CLIENT_REFRESH_HASH_SECRET=change_me_to_a_long_random_string

# ---- Admin auth ----
# Option A (recommended): Bearer token
ADMIN_TOKEN_SECRET=change_me_to_a_long_random_string
ADMIN_TOKEN_TTL_MINUTES=60

# Option B (fallback): API key header x-admin-api-key
# (If ADMIN_TOKEN_SECRET is set, Bearer token is used.)
ADMIN_API_KEY=

# ---- VNPay (optional for local dev) ----
# Keep as strings to satisfy env parsing; can be dummy values in demo.
VNPAY_TMN_CODE=DUMMY_TMN
VNPAY_HASH_SECRET=DUMMY_SECRET
VNPAY_RETURN_URL=http://localhost:5173/payment/return
VNPAY_IPN_URL=http://localhost:3001/api/v1/payments/vnpay/ipn
VNPAY_PAYMENT_URL=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html

VNPAY_VERSION=2.1.0
VNPAY_COMMAND=pay
VNPAY_CURR_CODE=VND
VNPAY_LOCALE=vn
VNPAY_ORDER_TYPE=other

# ---- Reservation rules ----
RESERVATION_MAX_DAYS=7
RESERVATION_PENDING_MINUTES=45
RESERVATION_CHECKIN_EARLY_MINUTES=30
RESERVATION_CHECKIN_LATE_MINUTES=15

# ---- Table status sync policy ----
TABLE_STATUS_LOCK_AHEAD_MINUTES=30

# ---- Maintenance jobs (optional) ----
# Auto-heal: auto-close stale sessions + expire/no-show reservations + sync table_status
MAINTENANCE_JOBS_ENABLED=false
MAINTENANCE_INTERVAL_SECONDS=120
MAINTENANCE_SESSION_STALE_MINUTES=360

# ---- Dev tools ----
# Allow destructive local reset endpoint for deterministic smoke/demo.
# Enabled by default when NODE_ENV != production.
DEV_RESET_ENABLED=true
